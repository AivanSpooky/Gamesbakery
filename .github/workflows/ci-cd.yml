name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  DOCKER_BUILDKIT: 1

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      db-container: ${{ steps.start-db.outputs.db-container }}
      web-container: ${{ steps.start-web.outputs.web-container }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Start database service
      id: start-db
      run: |
        docker-compose -f Gamesbakery/docker-compose.yml up -d db
        echo "db-container=$(docker-compose -f Gamesbakery/docker-compose.yml ps -q db)" >> $GITHUB_OUTPUT

    - name: Wait for database
      run: |
        timeout 300 sh -c 'until docker exec $(docker-compose -f Gamesbakery/docker-compose.yml ps -q db) /opt/mssql-tools18/bin/sqlcmd -S localhost,1433 -U sa -P YourStrong@Pass -Q "SELECT 1" -C -N >/dev/null 2>&1; do sleep 1; done'

    - name: Start web service
      id: start-web
      run: |
        docker-compose -f Gamesbakery/docker-compose.yml up -d web
        echo "web-container=$(docker-compose -f Gamesbakery/docker-compose.yml ps -q web)" >> $GITHUB_OUTPUT

    - name: Wait for web service
      run: |
        timeout 180 sh -c 'until curl -f http://localhost:8080/health >/dev/null 2>&1; do sleep 1; done'

  unit-tests:
    needs: setup
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Build and run unit tests
      run: |
        docker-compose -f Gamesbakery/docker-compose.yml build tests
        docker-compose -f Gamesbakery/docker-compose.yml run --rm tests sh -c "
          mkdir -p /app/allure-results/unit
          cd /app/build-bl && dotnet test Gamesbakery.BusinessLogic.Tests.dll --filter 'Category=Unit' --logger 'allure' --results-directory /app/allure-results/unit || true
        "

    - name: Copy unit test results
      if: always()
      run: |
        mkdir -p allure-results/unit
        docker cp $(docker-compose -f Gamesbakery/docker-compose.yml ps -q tests):/app/allure-results/unit ./allure-results/unit 2>/dev/null || true

    - name: Upload unit test report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: unit-allure-report
        path: allure-results/unit/

  integration-tests:
    needs: [setup, unit-tests]
    runs-on: ubuntu-latest
    if: needs.unit-tests.result == 'success'
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Build and run integration tests
      run: |
        docker-compose -f Gamesbakery/docker-compose.yml build tests
        docker-compose -f Gamesbakery/docker-compose.yml run --rm tests sh -c "
          mkdir -p /app/allure-results/integration
          cd /app/build-da && dotnet test Gamesbakery.DataAccess.Tests.dll --filter 'Category=Integration' --logger 'allure' --results-directory /app/allure-results/integration || true
        "

    - name: Copy integration test results
      if: always()
      run: |
        mkdir -p allure-results/integration
        docker cp $(docker-compose -f Gamesbakery/docker-compose.yml ps -q tests):/app/allure-results/integration ./allure-results/integration 2>/dev/null || true

    - name: Upload integration test report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: integration-allure-report
        path: allure-results/integration/

  e2e-tests:
    needs: [setup, integration-tests]
    runs-on: ubuntu-latest
    if: needs.integration-tests.result == 'success'
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Build and run E2E tests
      run: |
        docker-compose -f Gamesbakery/docker-compose.yml build tests
        docker-compose -f Gamesbakery/docker-compose.yml run --rm tests sh -c "
          mkdir -p /app/allure-results/e2e
          cd /app/build-e2e && dotnet test Gamesbakery.E2E.Tests.dll --filter 'Category=E2E' --logger 'allure' --results-directory /app/allure-results/e2e || true
        "

    - name: Copy E2E test results
      if: always()
      run: |
        mkdir -p allure-results/e2e
        docker cp $(docker-compose -f Gamesbakery/docker-compose.yml ps -q tests):/app/allure-results/e2e ./allure-results/e2e 2>/dev/null || true

    - name: Upload E2E test report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: e2e-allure-report
        path: allure-results/e2e/

  generate-report:
    needs: [unit-tests, integration-tests, e2e-tests]
    runs-on: ubuntu-latest
    if: always()
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download all test results
      uses: actions/download-artifact@v4
      with:
        path: allure-results

    - name: Generate combined Allure report
      run: |
        mkdir -p combined-results
        find allure-results -name "*.xml" -type f -exec cp {} combined-results/ \; 2>/dev/null || true
        
        docker run --rm \
          -v $(pwd)/combined-results:/app/allure-results \
          -v $(pwd)/allure-report:/app/allure-report \
          --entrypoint sh node:20 -c "
            npm install -g allure-commandline && \
            allure generate /app/allure-results -o /app/allure-report --clean
          " || true

    - name: Upload final Allure report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: final-allure-report
        path: allure-report/

  cleanup:
    needs: [unit-tests, integration-tests, e2e-tests]
    runs-on: ubuntu-latest
    if: always()
    steps:
    - name: Cleanup containers
      if: always()
      run: |
        docker-compose -f Gamesbakery/docker-compose.yml down -v || true
        docker system prune -f || true