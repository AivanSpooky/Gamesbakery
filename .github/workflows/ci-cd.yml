name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  DOCKER_BUILDKIT: 1

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      db-container: ${{ steps.start-db.outputs.db-container }}
      web-container: ${{ steps.start-web.outputs.web-container }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Start database service
      id: start-db
      run: |
        echo "Starting database service..."
        docker-compose up -d db
        echo "Waiting for database to be ready..."
        timeout=300
        for i in $(seq 1 $timeout); do
          if docker exec $(docker-compose ps -q db) /opt/mssql-tools18/bin/sqlcmd -S localhost,1433 -U sa -P YourStrong@Pass -Q "SELECT 1" -C -N >/dev/null 2>&1; then
            echo "✓ Database ready after ${i}s"
            break
          fi
          echo "Database not ready, attempt ${i}/${timeout}..."
          sleep 1
        done
        if [ $i -eq $timeout ]; then
          echo "❌ Database failed to start within ${timeout}s"
          exit 1
        fi
        echo "db-container=$(docker-compose ps -q db)" >> $GITHUB_OUTPUT

    - name: Start web service
      id: start-web
      run: |
        echo "Starting web service..."
        docker-compose up -d web
        echo "Waiting for web service to be ready..."
        timeout=180
        for i in $(seq 1 $timeout); do
          if curl -f http://localhost:8080/health >/dev/null 2>&1; then
            echo "✓ Web service ready after ${i}s"
            break
          fi
          echo "Web service not ready, attempt ${i}/${timeout}..."
          sleep 1
        done
        if [ $i -eq $timeout ]; then
          echo "❌ Web service failed to start within ${timeout}s"
          exit 1
        fi
        echo "web-container=$(docker-compose ps -q web)" >> $GITHUB_OUTPUT

  unit-tests:
    needs: setup
    runs-on: ubuntu-latest
    if: always()
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build tests
      run: |
        docker-compose build tests

    - name: Run Unit Tests
      run: |
        echo "=== Running Unit Tests ==="
        docker-compose run --rm tests sh -c "
          mkdir -p /app/allure-results/unit
          cd /app/build-bl && dotnet test Gamesbakery.BusinessLogic.Tests.dll --filter 'Category=Unit' --logger 'allure' --results-directory /app/allure-results/unit || true
        "
        echo "Unit tests completed"

    - name: Copy Unit Test Results
      if: always()
      run: |
        mkdir -p allure-results/unit
        docker cp $(docker-compose ps -q tests):/app/allure-results/unit ./allure-results/unit 2>/dev/null || true
        echo "Unit test results copied"

    - name: Upload Unit Test Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: unit-allure-report
        path: allure-results/unit/

  integration-tests:
    needs: [setup, unit-tests]
    runs-on: ubuntu-latest
    if: needs.unit-tests.result