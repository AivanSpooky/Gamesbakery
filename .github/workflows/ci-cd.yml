name: CI/CD Pipeline

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    
    - name: Clean migration duplicates
      run: |
        # Удаляем дубликаты миграций
        find . -name "*Migration*.cs" -exec grep -l "Duplicate" {} \; | xargs rm -f
        find . -name "*Migration*.Designer.cs" -exec grep -l "Duplicate" {} \; | xargs rm -f
        
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with: { dotnet-version: '8.0.x' }
    
    - name: Clean and restore
      run: |
        dotnet clean
        dotnet restore
    
    - name: Run Unit Tests
      run: dotnet test Gamesbakery/Gamesbakery.BusinessLogic.Tests/Gamesbakery.BusinessLogic.Tests.csproj --no-build || true
    
    - name: Run Integration Tests
      run: dotnet test Gamesbakery/Gamesbakery.DataAccess.Tests/Gamesbakery.DataAccess.Tests.csproj --no-build || true
    
    - name: Run E2E Tests
      run: |
        # Копируем appsettings.json для E2E тестов
        cp Gamesbakery/Gamesbakery.E2E.Tests/appsettings.json Gamesbakery/Gamesbakery.E2E.Tests/bin/Debug/net8.0/ || true
        cp Gamesbakery/Gamesbakery.E2E.Tests/appsettings.json Gamesbakery/Gamesbakery.E2E.Tests/bin/Release/net8.0/ || true
        dotnet test Gamesbakery/Gamesbakery.E2E.Tests/Gamesbakery.E2E.Tests.csproj --no-build || true