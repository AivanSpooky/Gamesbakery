FROM mcr.microsoft.com/dotnet/sdk:8.0

# Install dependencies
USER root
RUN apt-get update && \
    apt-get install -y \
    openjdk-17-jre-headless \
    curl \
    netcat-openbsd \
    wget \
    && rm -rf /var/lib/apt/lists/*

# Install Allure
RUN wget https://github.com/allure-framework/allure2/releases/download/2.27.0/allure-2.27.0.tgz && \
    tar -zxvf allure-2.27.0.tgz -C /opt/ && \
    ln -s /opt/allure-2.27.0/bin/allure /usr/bin/allure && \
    rm allure-2.27.0.tgz

# Install dotnet-ef globally
RUN dotnet tool install --global dotnet-ef --version 8.0.8
ENV PATH="$PATH:/root/.dotnet/tools"

RUN mkdir -p /app/allure-results/bl /app/allure-results/da /app/allure-results/e2e /app/logs /app/build-bl /app/build-da /app/build-e2e && \
    chmod -R 777 /app

WORKDIR /app

# Copy project files for restore (optimization)
COPY Gamesbakery.BusinessLogic.Tests/Gamesbakery.BusinessLogic.Tests.csproj ./Gamesbakery.BusinessLogic.Tests/
COPY Gamesbakery.DataAccess.Tests/Gamesbakery.DataAccess.Tests.csproj ./Gamesbakery.DataAccess.Tests/
COPY Gamesbakery.E2E.Tests/Gamesbakery.E2E.Tests.csproj ./Gamesbakery.E2E.Tests/
COPY Gamesbakery.BusinessLogic/Gamesbakery.BusinessLogic.csproj ./Gamesbakery.BusinessLogic/
COPY Gamesbakery.Core/Gamesbakery.Core.csproj ./Gamesbakery.Core/
COPY Gamesbakery.DataAccess/Gamesbakery.DataAccess.csproj ./Gamesbakery.DataAccess/
COPY Gamesbakery.Infrastructure/Gamesbakery.Infrastructure.csproj ./Gamesbakery.Infrastructure/

# Restore packages
RUN dotnet restore ./Gamesbakery.BusinessLogic.Tests/Gamesbakery.BusinessLogic.Tests.csproj && \
    dotnet restore ./Gamesbakery.DataAccess.Tests/Gamesbakery.DataAccess.Tests.csproj && \
    dotnet restore ./Gamesbakery.E2E.Tests/Gamesbakery.E2E.Tests.csproj

# Copy source code
COPY Gamesbakery.BusinessLogic.Tests/ ./Gamesbakery.BusinessLogic.Tests/
COPY Gamesbakery.DataAccess.Tests/ ./Gamesbakery.DataAccess.Tests/
COPY Gamesbakery.E2E.Tests/ ./Gamesbakery.E2E.Tests/
COPY Gamesbakery.BusinessLogic/ ./Gamesbakery.BusinessLogic/
COPY Gamesbakery.Core/ ./Gamesbakery.Core/
COPY Gamesbakery.DataAccess/ ./Gamesbakery.DataAccess/
COPY Gamesbakery.Infrastructure/ ./Gamesbakery.Infrastructure/

#  Œœ»–”≈Ã  ŒÕ‘»√”–¿÷»ŒÕÕ€≈ ‘¿…À€
COPY ./allureConfig.json /app/allureConfig.json
COPY ./Gamesbakery.E2E.Tests/appsettings.json /app/build-e2e/appsettings.json

# Build test projects
RUN dotnet build Gamesbakery.BusinessLogic.Tests/Gamesbakery.BusinessLogic.Tests.csproj -c Release -o ./build-bl --no-restore && \
    dotnet build Gamesbakery.DataAccess.Tests/Gamesbakery.DataAccess.Tests.csproj -c Release -o ./build-da --no-restore && \
    dotnet build Gamesbakery.E2E.Tests/Gamesbakery.E2E.Tests.csproj -c Release -o ./build-e2e --no-restore

# Create symlinks for Allure results
RUN ln -sf /app/allure-results/bl /app/build-bl/allure-results && \
    ln -sf /app/allure-results/da /app/build-da/allure-results && \
    ln -sf /app/allure-results/e2e /app/build-e2e/allure-results

# Default command
CMD ["sleep", "infinity"]